macro(find_libwebsockets)

  include(FindPkgConfig)

  unset(LIBWEBSOCKETS_INCLUDE_DIRS CACHE)
  unset(LIBWEBSOCKETS_LIBRARY_DIR CACHE)
  unset(LIBWEBSOCKETS_LIBRARIES CACHE)
  unset(LIBWEBSOCKETS_FOUND CACHE)

  pkg_check_modules(LIBWEBSOCKETS libwebsockets)
  pkg_search_module(OPENSSL openssl)

  #dump(LIBWEBSOCKETS_FOUND LIBWEBSOCKETS_LIBRARIES LIBWEBSOCKETS_LINK_LIBRARIES LIBWEBSOCKETS_LIBRARY_DIRS LIBWEBSOCKETS_LDFLAGS LIBWEBSOCKETS_LDFLAGS_OTHER LIBWEBSOCKETS_INCLUDE_DIRS LIBWEBSOCKETS_CFLAGS LIBWEBSOCKETS_CFLAGS_OTHER LIBWEBSOCKETS_VERSION LIBWEBSOCKETS_PREFIX LIBWEBSOCKETS_INCLUDEDIR LIBWEBSOCKETS_LIBDIR)

  if(NOT LIBWEBSOCKETS_LIBRARIES)
    if(pkgcfg_lib_LIBWEBSOCKETS_websockets AND EXISTS "${pkgcfg_lib_LIBWEBSOCKETS_websockets}")
      set(LIBWEBSOCKETS_LIBRARIES "${pkgcfg_lib_LIBWEBSOCKETS_websockets}" CACHE FILEPATH "libwebsockets library")
    endif(pkgcfg_lib_LIBWEBSOCKETS_websockets AND EXISTS "${pkgcfg_lib_LIBWEBSOCKETS_websockets}")
  endif(LIBWEBSOCKETS_LIBRARIES)

  if(LIBWEBSOCKETS_LIBRARIES AND LIBWEBSOCKETS_LIBRARIES MATCHES ".*/.*")
    string(REGEX REPLACE "/[^/]*$" "" LIBWEBSOCKETS_LIBRARY_DIR "${LIBWEBSOCKETS_LIBRARIES}")
    string(REGEX REPLACE "/lib/.*$" "/include" LIBWEBSOCKETS_INCLUDE_DIRS "${LIBWEBSOCKETS_LIBRARIES}")
    set(LIBWEBSOCKETS_LIBRARY_DIR "${LIBWEBSOCKETS_LIBRARY_DIR}" CACHE PATH "libwebsockets library directory")
    set(LIBWEBSOCKETS_INCLUDE_DIRS "${LIBWEBSOCKETS_INCLUDE_DIRS};${OPENSSL_INCLUDE_DIR}" CACHE PATH "libwebsockets include directory")
  endif(LIBWEBSOCKETS_LIBRARIES AND LIBWEBSOCKETS_LIBRARIES MATCHES ".*/.*")

  if(CMAKE_INSTALL_RPATH)
    set(CMAKE_INSTALL_RPATH "${LIBWEBSOCKETS_LIBRARY_DIR}:${CMAKE_INSTALL_RPATH}" CACHE PATH "Install runtime path")
  else(CMAKE_INSTALL_RPATH)
    set(CMAKE_INSTALL_RPATH "${LIBWEBSOCKETS_LIBRARY_DIR}" CACHE PATH "Install runtime path")
  endif(CMAKE_INSTALL_RPATH)

endmacro(find_libwebsockets)
